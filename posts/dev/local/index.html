<!doctype html><html lang=en>
<head>
<meta charset=utf-8>
<meta name=viewport content="width=device-width,initial-scale=1">
<meta name=robots content="noodp">
<title class=pjax-title>Local development setting - YakuShou's NOTEBOOK</title><meta name=Description content="local development setting"><meta property="og:title" content="Local development setting">
<meta property="og:description" content="local development setting">
<meta property="og:type" content="article">
<meta property="og:url" content="https://blog.yakushou.com/posts/dev/local/"><meta property="article:section" content="posts">
<meta property="article:published_time" content="2022-05-08T18:33:11+08:00">
<meta property="article:modified_time" content="2022-05-08T18:33:11+08:00">
<meta name=twitter:card content="summary">
<meta name=twitter:title content="Local development setting">
<meta name=twitter:description content="local development setting">
<meta name=application-name content="YakuShou's NOTEBOOK">
<meta name=apple-mobile-web-app-title content="YakuShou's NOTEBOOK">
<meta name=theme-color content="#f8f8f8"><link rel="shortcut icon" type=image/x-icon href=/favicon.ico>
<link rel=icon type=image/png sizes=32x32 href=/favicon-32x32.png>
<link rel=icon type=image/png sizes=16x16 href=/favicon-16x16.png><link rel=apple-touch-icon sizes=180x180 href=/apple-touch-icon.png><link rel=canonical href=https://blog.yakushou.com/posts/dev/local/><link rel=prev href=https://blog.yakushou.com/posts/golang/fundamental2/><link rel=stylesheet href=/lib/normalize/normalize.min.css><link rel=stylesheet href=/css/style.min.css><link rel=preload as=style onload="this.onload=null,this.rel='stylesheet'" href=/lib/fontawesome-free/all.min.css>
<noscript><link rel=stylesheet href=/lib/fontawesome-free/all.min.css></noscript><link rel=preload as=style onload="this.onload=null,this.rel='stylesheet'" href=/lib/animate/animate.min.css>
<noscript><link rel=stylesheet href=/lib/animate/animate.min.css></noscript><script type=application/ld+json>{"@context":"http://schema.org","@type":"BlogPosting","headline":"Local development setting","inLanguage":"en","mainEntityOfPage":{"@type":"WebPage","@id":"https:\/\/blog.yakushou.com\/posts\/dev\/local\/"},"genre":"posts","keywords":"local","wordcount":955,"url":"https:\/\/blog.yakushou.com\/posts\/dev\/local\/","datePublished":"2022-05-08T18:33:11+08:00","dateModified":"2022-05-08T18:33:11+08:00","publisher":{"@type":"Organization","name":"Author"},"authors":[{"@type":"Person","name":"yakushou730"}],"description":"local development setting"}</script></head>
<body header-desktop header-mobile><script type=text/javascript>function setTheme(a){document.body.setAttribute('theme',a)}function saveTheme(a){window.localStorage&&localStorage.setItem('theme',a)}function getMeta(b){const a=document.getElementsByTagName('meta');for(let c=0;c<a.length;c++)if(a[c].getAttribute('name')===b)return a[c];return''}if(window.localStorage&&localStorage.getItem('theme')){let a=localStorage.getItem('theme');a==='light'||a==='dark'||a==='black'?setTheme(a):window.matchMedia&&window.matchMedia('(prefers-color-scheme: dark)').matches?setTheme('dark'):setTheme('light')}else''==='light'||''==='dark'||''==='black'?(setTheme(''),saveTheme('')):(saveTheme('auto'),window.matchMedia&&window.matchMedia('(prefers-color-scheme: dark)').matches?setTheme('dark'):setTheme('light'));let metaColors={light:'#f8f8f8',dark:'#252627',black:'#000000'};getMeta('theme-color').content=metaColors[document.body.getAttribute('theme')]</script>
<div id=back-to-top></div>
<div id=mask></div><div class=wrapper><header class=desktop id=header-desktop>
<div class=header-wrapper>
<div class=header-title>
<a href=/ title="YakuShou's NOTEBOOK">YakuShou's NOTEBOOK</a>
</div>
<div class=menu>
<div class=menu-inner><a class=menu-item href=/posts/> Posts </a><a class=menu-item href=/tags/> Tags </a><span class="menu-item delimiter"></span><a href=# onclick=return!1 class="menu-item theme-switch" title="Switch Theme">
<i class="fas fa-adjust fa-fw"></i>
</a></div>
</div>
</div>
</header><header class=mobile id=header-mobile>
<div class=header-container>
<div class=header-wrapper>
<div class=header-title>
<a href=/ title="YakuShou's NOTEBOOK">YakuShou's NOTEBOOK</a>
</div>
<div class=menu-toggle id=menu-toggle-mobile>
<span></span><span></span><span></span>
</div>
</div>
<div class=menu id=menu-mobile><a class=menu-item href=/posts/ title>Posts</a><a class=menu-item href=/tags/ title>Tags</a><a href=# onclick=return!1 class="menu-item theme-switch" title="Switch Theme">
<i class="fas fa-adjust fa-fw"></i>
</a></div>
</div>
</header>
<div class="search-dropdown desktop">
<div id=search-dropdown-desktop></div>
</div>
<div class="search-dropdown mobile">
<div id=search-dropdown-mobile></div>
</div>
<main class=main>
<div class=container><div class=toc id=toc-auto>
<h2 class=toc-title>Contents</h2>
<div class=toc-content id=toc-content-auto></div>
</div><script>document.getElementsByTagName("main")[0].setAttribute("pageStyle","normal")</script><article class="page single"><h1 class="single-title animate__animated animate__flipInX">Local development setting</h1><div class=post-meta>
<div class=post-meta-line>
<span class=post-author><span class=author><i class="author fas fa-user-circle fa-fw"></i><span class=screen-reader-text> </span><a href=https://blog.yakushou.com/authors/yakushou730>yakushou730</a></span>
</span></div>
<div class=post-meta-line><i class="far fa-calendar-alt fa-fw"></i>&nbsp;<time datetime=2022-05-08>2022-05-08</time>&nbsp;<i class="far fa-edit fa-fw"></i>&nbsp;<time datetime=2022-05-08>2022-05-08</time>&nbsp;<i class="fas fa-pencil-alt fa-fw"></i>&nbsp;955 words&nbsp;
<i class="far fa-clock fa-fw"></i>&nbsp;5 minutes&nbsp;</div>
</div><div class="details toc" id=toc-static kept>
<div class="details-summary toc-title">
<span>Contents</span>
<span><i class="details-icon fas fa-angle-right"></i></span>
</div>
<div class="details-content toc-content" id=toc-content-static><nav id=TableOfContents>
<ul>
<li><a href=#本機開發安裝項目>本機開發安裝項目</a>
<ul>
<li></li>
</ul>
</li>
</ul>
</nav></div>
</div><div class=content id=content><p>整理</p>
<table>
<thead>
<tr>
<th>service</th>
<th>local</th>
<th>k8s</th>
<th>username</th>
<th>password</th>
</tr>
</thead>
<tbody>
<tr>
<td>mysql</td>
<td>30000</td>
<td>3306</td>
<td>root</td>
<td>secret</td>
</tr>
<tr>
<td>postgresql</td>
<td>30001</td>
<td>5432</td>
<td>root</td>
<td>secret</td>
</tr>
<tr>
<td>redis</td>
<td>30002</td>
<td>6379</td>
<td></td>
<td></td>
</tr>
<tr>
<td>etcd</td>
<td>30003</td>
<td>2379, 2380</td>
<td>root</td>
<td></td>
</tr>
</tbody>
</table>
<h2 id=本機開發安裝項目>本機開發安裝項目</h2>
<h4 id=zsh>zsh</h4>
<ol>
<li>安裝 powerlevel10k 主題
<ul>
<li><a href=https://github.com/romkatv/powerlevel10k#oh-my-zsh target=_blank rel="noopener noreffer">site</a></li>
</ul>
</li>
</ol>
<h4 id=golang>golang</h4>
<ol>
<li>先至 golang 官網安裝一版新的 golang (因為要有 golang 才可以 build golang)
<ul>
<li><a href=https://go.dev/dl/ target=_blank rel="noopener noreffer">website install</a></li>
</ul>
</li>
<li>安裝 GVM 來管理 golang 套件
<ul>
<li><a href=https://github.com/moovweb/gvm target=_blank rel="noopener noreffer">site</a></li>
</ul>
</li>
<li>GVM 安裝後就可以安裝各種對應版本的 golang
<ul>
<li>intel 是 amd64</li>
<li>M1 (apple silicon) 是 arm64</li>
</ul>
</li>
<li>安裝 Goland
<ul>
<li><a href=https://www.jetbrains.com/go/ target=_blank rel="noopener noreffer">website install</a></li>
</ul>
</li>
</ol>
<p>Optional:</p>
<ol>
<li>安裝 <a href=https://github.com/divan/expvarmon target=_blank rel="noopener noreffer">expvarmon</a>
<ul>
<li>用來看 pprof 的效能</li>
</ul>
</li>
</ol>
<h4 id=git>git</h4>
<ol>
<li>安裝 cz-conventional
<ul>
<li><a href=https://github.com/commitizen/cz-conventional-changelog target=_blank rel="noopener noreffer">site</a></li>
<li>這樣可以用 <code>git cz</code> 來做到統一的 commit</li>
</ul>
</li>
</ol>
<div class=highlight><pre tabindex=0 class=chroma><code class=language-shell data-lang=shell>npm install -g commitizen cz-conventional-changelog
<span class=nb>echo</span> <span class=s1>&#39;{ &#34;path&#34;: &#34;cz-conventional-changelog&#34; }&#39;</span> &gt; ~/.czrc
</code></pre></div><h4 id=k8s>K8S</h4>
<ol>
<li>安裝 docker
<ul>
<li><a href=https://www.docker.com/get-started/ target=_blank rel="noopener noreffer">website install</a></li>
</ul>
</li>
<li>安裝 kubectl
<ul>
<li><a href=https://kubernetes.io/docs/tasks/tools/install-kubectl-macos/ target=_blank rel="noopener noreffer">site</a></li>
</ul>
</li>
<li>安裝 helm
<ul>
<li><a href=https://helm.sh/docs/intro/install/ target=_blank rel="noopener noreffer">site</a></li>
</ul>
</li>
<li>安裝 k3d
<ul>
<li><a href=https://k3d.io/v5.4.1/ target=_blank rel="noopener noreffer">site</a></li>
</ul>
</li>
<li>下指令建出 local 端的 cluster</li>
</ol>
<div class=highlight><pre tabindex=0 class=chroma><code class=language-shell data-lang=shell>k3d cluster create local-cluster --registry-create local-registry -p <span class=s2>&#34;30000-30200:30000-30200@server:0&#34;</span>
</code></pre></div><p>如果要把 local image 載入到 k3d 的話，指令為</p>
<div class=highlight><pre tabindex=0 class=chroma><code class=language-shell data-lang=shell>k3d image import -c local-cluster service-amd64:1.0
</code></pre></div><ol start=6>
<li>安裝 kustomiize
<ul>
<li><a href=https://kubectl.docs.kubernetes.io/installation/kustomize/ target=_blank rel="noopener noreffer">site</a></li>
</ul>
</li>
</ol>
<h4 id=其他服務>其他服務</h4>
<ol>
<li>透過 helm 安裝 mysql
<ul>
<li><a href=https://artifacthub.io/packages/helm/bitnami/mysql target=_blank rel="noopener noreffer">site</a></li>
</ul>
</li>
</ol>
<div class=highlight><pre tabindex=0 class=chroma><code class=language-shell data-lang=shell>helm repo add bitnami https://charts.bitnami.com/bitnami
helm install local-mysql <span class=se>\
</span><span class=se></span>  --set auth.rootPassword<span class=o>=</span>secret,auth.database<span class=o>=</span>db_dev <span class=se>\
</span><span class=se></span>    bitnami/mysql
</code></pre></div><p>Result</p>
<div class=highlight><pre tabindex=0 class=chroma><code class=language-shell data-lang=shell>NAME: local-mysql
LAST DEPLOYED: Sun May  <span class=m>8</span> 19:04:49 <span class=m>2022</span>
NAMESPACE: default
STATUS: deployed
REVISION: <span class=m>1</span>
TEST SUITE: None
NOTES:
CHART NAME: mysql
CHART VERSION: 8.8.26
APP VERSION: 8.0.28

** Please be patient <span class=k>while</span> the chart is being deployed **

Tip:

  Watch the deployment status using the command: kubectl get pods -w --namespace default

Services:

  <span class=nb>echo</span> Primary: local-mysql.default.svc.cluster.local:3306

Execute the following to get the administrator credentials:

  <span class=nb>echo</span> Username: root
  <span class=nv>MYSQL_ROOT_PASSWORD</span><span class=o>=</span><span class=k>$(</span>kubectl get secret --namespace default local-mysql -o <span class=nv>jsonpath</span><span class=o>=</span><span class=s2>&#34;{.data.mysql-root-password}&#34;</span> <span class=p>|</span> base64 --decode<span class=k>)</span>

To connect to your database:

  1. Run a pod that you can use as a client:

      kubectl run local-mysql-client --rm --tty -i --restart<span class=o>=</span><span class=s1>&#39;Never&#39;</span> --image  docker.io/bitnami/mysql:8.0.28-debian-10-r23 --namespace default --command -- bash

  2. To connect to primary service <span class=o>(</span>read/write<span class=o>)</span>:

      mysql -h local-mysql.default.svc.cluster.local -uroot -p<span class=s2>&#34;</span><span class=nv>$MYSQL_ROOT_PASSWORD</span><span class=s2>&#34;</span>



To upgrade this helm chart:

  1. Obtain the password as described on the <span class=s1>&#39;Administrator credentials&#39;</span> section and <span class=nb>set</span> the <span class=s1>&#39;root.password&#39;</span> parameter as shown below:

      <span class=nv>ROOT_PASSWORD</span><span class=o>=</span><span class=k>$(</span>kubectl get secret --namespace default local-mysql -o <span class=nv>jsonpath</span><span class=o>=</span><span class=s2>&#34;{.data.mysql-root-password}&#34;</span> <span class=p>|</span> base64 --decode<span class=k>)</span>
      helm upgrade --namespace default local-mysql bitnami/mysql --set auth.rootPassword<span class=o>=</span><span class=nv>$ROOT_PASSWORD</span>
</code></pre></div><p>建立一個 node port 來通 mysql</p>
<p>local-mysql-svc</p>
<div class=highlight><pre tabindex=0 class=chroma><code class=language-yaml data-lang=yaml><span class=nt>apiVersion</span><span class=p>:</span><span class=w> </span><span class=l>v1</span><span class=w>
</span><span class=w></span><span class=nt>kind</span><span class=p>:</span><span class=w> </span><span class=l>Service</span><span class=w>
</span><span class=w></span><span class=nt>metadata</span><span class=p>:</span><span class=w>
</span><span class=w>  </span><span class=nt>name</span><span class=p>:</span><span class=w> </span><span class=l>local-mysql-svc</span><span class=w>
</span><span class=w></span><span class=nt>spec</span><span class=p>:</span><span class=w>
</span><span class=w>  </span><span class=nt>type</span><span class=p>:</span><span class=w> </span><span class=l>NodePort</span><span class=w>
</span><span class=w>  </span><span class=nt>selector</span><span class=p>:</span><span class=w>
</span><span class=w>    </span><span class=nt>app.kubernetes.io/name</span><span class=p>:</span><span class=w> </span><span class=l>mysql</span><span class=w>
</span><span class=w>    </span><span class=nt>app.kubernetes.io/instance</span><span class=p>:</span><span class=w> </span><span class=l>local-mysql</span><span class=w>
</span><span class=w>    </span><span class=nt>app.kubernetes.io/managed-by</span><span class=p>:</span><span class=w> </span><span class=l>Helm</span><span class=w>
</span><span class=w>  </span><span class=nt>ports</span><span class=p>:</span><span class=w>
</span><span class=w>    </span>- <span class=nt>port</span><span class=p>:</span><span class=w> </span><span class=m>3306</span><span class=w>
</span><span class=w>      </span><span class=nt>nodePort</span><span class=p>:</span><span class=w> </span><span class=m>30000</span><span class=w>
</span><span class=w>      </span><span class=nt>targetPort</span><span class=p>:</span><span class=w> </span><span class=m>3306</span><span class=w>
</span><span class=w>      </span><span class=nt>protocol</span><span class=p>:</span><span class=w> </span><span class=l>TCP</span><span class=w>
</span></code></pre></div><p>這樣可以透過 localhost:30000 來連接到 k3d 內的 3306</p>
<ol start=2>
<li>透過 helm 安裝 postgresql
<ul>
<li><a href=https://artifacthub.io/packages/helm/bitnami/postgresql target=_blank rel="noopener noreffer">site</a></li>
</ul>
</li>
</ol>
<div class=highlight><pre tabindex=0 class=chroma><code class=language-shell data-lang=shell>helm install my-release bitnami/postgresql
helm install local-postgresql <span class=se>\
</span><span class=se></span>  --set global.postgresql.auth.username<span class=o>=</span>root,global.postgresql.auth.password<span class=o>=</span>secret,global.postgresql.auth.database<span class=o>=</span>db_dev <span class=se>\
</span><span class=se></span>    bitnami/postgresql
</code></pre></div><p>Result</p>
<div class=highlight><pre tabindex=0 class=chroma><code class=language-shell data-lang=shell>NAME: local-postgresql
LAST DEPLOYED: Sun May  <span class=m>8</span> 22:05:30 <span class=m>2022</span>
NAMESPACE: default
STATUS: deployed
REVISION: <span class=m>1</span>
TEST SUITE: None
NOTES:
CHART NAME: postgresql
CHART VERSION: 11.1.6
APP VERSION: 14.2.0

** Please be patient <span class=k>while</span> the chart is being deployed **

PostgreSQL can be accessed via port <span class=m>5432</span> on the following DNS names from within your cluster:

    local-postgresql.default.svc.cluster.local - Read/Write connection

To get the password <span class=k>for</span> <span class=s2>&#34;postgres&#34;</span> run:

    <span class=nb>export</span> <span class=nv>POSTGRES_ADMIN_PASSWORD</span><span class=o>=</span><span class=k>$(</span>kubectl get secret --namespace default local-postgresql -o <span class=nv>jsonpath</span><span class=o>=</span><span class=s2>&#34;{.data.postgres-password}&#34;</span> <span class=p>|</span> base64 --decode<span class=k>)</span>

To get the password <span class=k>for</span> <span class=s2>&#34;root&#34;</span> run:

    <span class=nb>export</span> <span class=nv>POSTGRES_PASSWORD</span><span class=o>=</span><span class=k>$(</span>kubectl get secret --namespace default local-postgresql -o <span class=nv>jsonpath</span><span class=o>=</span><span class=s2>&#34;{.data.password}&#34;</span> <span class=p>|</span> base64 --decode<span class=k>)</span>

To connect to your database run the following command:

    kubectl run local-postgresql-client --rm --tty -i --restart<span class=o>=</span><span class=s1>&#39;Never&#39;</span> --namespace default --image docker.io/bitnami/postgresql:14.2.0-debian-10-r25 --env<span class=o>=</span><span class=s2>&#34;PGPASSWORD=</span><span class=nv>$POSTGRES_PASSWORD</span><span class=s2>&#34;</span> <span class=se>\
</span><span class=se></span>      --command -- psql --host local-postgresql -U root -d db_dev -p <span class=m>5432</span>

    &gt; NOTE: If you access the container using bash, make sure that you execute <span class=s2>&#34;/opt/bitnami/scripts/entrypoint.sh /bin/bash&#34;</span> in order to avoid the error <span class=s2>&#34;psql: local user with ID 1001} does not exist&#34;</span>

To connect to your database from outside the cluster execute the following commands:

    kubectl port-forward --namespace default svc/local-postgresql 5432:5432 <span class=p>&amp;</span>
    <span class=nv>PGPASSWORD</span><span class=o>=</span><span class=s2>&#34;</span><span class=nv>$POSTGRES_PASSWORD</span><span class=s2>&#34;</span> psql --host 127.0.0.1 -U root -d db_dev -p <span class=m>5432</span>
</code></pre></div><p>建立一個 node port 來通 postgresql</p>
<p>local-postgresql-svc</p>
<div class=highlight><pre tabindex=0 class=chroma><code class=language-yaml data-lang=yaml><span class=nt>apiVersion</span><span class=p>:</span><span class=w> </span><span class=l>v1</span><span class=w>
</span><span class=w></span><span class=nt>kind</span><span class=p>:</span><span class=w> </span><span class=l>Service</span><span class=w>
</span><span class=w></span><span class=nt>metadata</span><span class=p>:</span><span class=w>
</span><span class=w>   </span><span class=nt>name</span><span class=p>:</span><span class=w> </span><span class=l>local-postgresql-svc</span><span class=w>
</span><span class=w></span><span class=nt>spec</span><span class=p>:</span><span class=w>
</span><span class=w>   </span><span class=nt>type</span><span class=p>:</span><span class=w> </span><span class=l>NodePort</span><span class=w>
</span><span class=w>   </span><span class=nt>selector</span><span class=p>:</span><span class=w>
</span><span class=w>      </span><span class=nt>app.kubernetes.io/name</span><span class=p>:</span><span class=w> </span><span class=l>postgresql</span><span class=w>
</span><span class=w>      </span><span class=nt>app.kubernetes.io/instance</span><span class=p>:</span><span class=w> </span><span class=l>local-postgresql</span><span class=w>
</span><span class=w>      </span><span class=nt>app.kubernetes.io/managed-by</span><span class=p>:</span><span class=w> </span><span class=l>Helm</span><span class=w>
</span><span class=w>   </span><span class=nt>ports</span><span class=p>:</span><span class=w>
</span><span class=w>      </span>- <span class=nt>port</span><span class=p>:</span><span class=w> </span><span class=m>5432</span><span class=w>
</span><span class=w>        </span><span class=nt>nodePort</span><span class=p>:</span><span class=w> </span><span class=m>30001</span><span class=w>
</span><span class=w>        </span><span class=nt>targetPort</span><span class=p>:</span><span class=w> </span><span class=m>5432</span><span class=w>
</span><span class=w>        </span><span class=nt>protocol</span><span class=p>:</span><span class=w> </span><span class=l>TCP</span><span class=w>
</span></code></pre></div><p>這樣可以透過 localhost:30001 來連接到 k3d 內的 5432</p>
<ol start=2>
<li>透過 helm 安裝 redis
<ul>
<li><a href=https://artifacthub.io/packages/helm/bitnami/redis target=_blank rel="noopener noreffer">site</a></li>
</ul>
</li>
</ol>
<div class=highlight><pre tabindex=0 class=chroma><code class=language-shell data-lang=shell>helm install local-redis bitnami/redis
</code></pre></div><p>Result</p>
<div class=highlight><pre tabindex=0 class=chroma><code class=language-shell data-lang=shell>NAME: local-redis
LAST DEPLOYED: Sun May  <span class=m>8</span> 22:13:31 <span class=m>2022</span>
NAMESPACE: default
STATUS: deployed
REVISION: <span class=m>1</span>
TEST SUITE: None
NOTES:
CHART NAME: redis
CHART VERSION: 16.5.2
APP VERSION: 6.2.6

** Please be patient <span class=k>while</span> the chart is being deployed **

Redis<span class=p>&amp;</span>trade<span class=p>;</span> can be accessed on the following DNS names from within your cluster:

    local-redis-master.default.svc.cluster.local <span class=k>for</span> read/write operations <span class=o>(</span>port 6379<span class=o>)</span>
    local-redis-replicas.default.svc.cluster.local <span class=k>for</span> read-only operations <span class=o>(</span>port 6379<span class=o>)</span>



To get your password run:

    <span class=nb>export</span> <span class=nv>REDIS_PASSWORD</span><span class=o>=</span><span class=k>$(</span>kubectl get secret --namespace default local-redis -o <span class=nv>jsonpath</span><span class=o>=</span><span class=s2>&#34;{.data.redis-password}&#34;</span> <span class=p>|</span> base64 --decode<span class=k>)</span>

To connect to your Redis<span class=p>&amp;</span>trade<span class=p>;</span> server:

1. Run a Redis<span class=p>&amp;</span>trade<span class=p>;</span> pod that you can use as a client:

   kubectl run --namespace default redis-client --restart<span class=o>=</span><span class=s1>&#39;Never&#39;</span>  --env <span class=nv>REDIS_PASSWORD</span><span class=o>=</span><span class=nv>$REDIS_PASSWORD</span>  --image docker.io/bitnami/redis:6.2.6-debian-10-r146 --command -- sleep infinity

   Use the following <span class=nb>command</span> to attach to the pod:

   kubectl <span class=nb>exec</span> --tty -i redis-client <span class=se>\
</span><span class=se></span>   --namespace default -- bash

2. Connect using the Redis<span class=p>&amp;</span>trade<span class=p>;</span> CLI:
   <span class=nv>REDISCLI_AUTH</span><span class=o>=</span><span class=s2>&#34;</span><span class=nv>$REDIS_PASSWORD</span><span class=s2>&#34;</span> redis-cli -h local-redis-master
   <span class=nv>REDISCLI_AUTH</span><span class=o>=</span><span class=s2>&#34;</span><span class=nv>$REDIS_PASSWORD</span><span class=s2>&#34;</span> redis-cli -h local-redis-replicas

To connect to your database from outside the cluster execute the following commands:

    kubectl port-forward --namespace default svc/local-redis-master : <span class=p>&amp;</span>
    <span class=nv>REDISCLI_AUTH</span><span class=o>=</span><span class=s2>&#34;</span><span class=nv>$REDIS_PASSWORD</span><span class=s2>&#34;</span> redis-cli -h 127.0.0.1 -p
</code></pre></div><p>建立一個 node port 來通 redis</p>
<p>local-redis-svc</p>
<div class=highlight><pre tabindex=0 class=chroma><code class=language-yaml data-lang=yaml><span class=nt>apiVersion</span><span class=p>:</span><span class=w> </span><span class=l>v1</span><span class=w>
</span><span class=w></span><span class=nt>kind</span><span class=p>:</span><span class=w> </span><span class=l>Service</span><span class=w>
</span><span class=w></span><span class=nt>metadata</span><span class=p>:</span><span class=w>
</span><span class=w>   </span><span class=nt>name</span><span class=p>:</span><span class=w> </span><span class=l>local-redis-svc</span><span class=w>
</span><span class=w></span><span class=nt>spec</span><span class=p>:</span><span class=w>
</span><span class=w>   </span><span class=nt>type</span><span class=p>:</span><span class=w> </span><span class=l>NodePort</span><span class=w>
</span><span class=w>   </span><span class=nt>selector</span><span class=p>:</span><span class=w>
</span><span class=w>      </span><span class=nt>app.kubernetes.io/name</span><span class=p>:</span><span class=w> </span><span class=l>redis</span><span class=w>
</span><span class=w>      </span><span class=nt>app.kubernetes.io/instance</span><span class=p>:</span><span class=w> </span><span class=l>local-redis</span><span class=w>
</span><span class=w>      </span><span class=nt>app.kubernetes.io/managed-by</span><span class=p>:</span><span class=w> </span><span class=l>Helm</span><span class=w>
</span><span class=w>   </span><span class=nt>ports</span><span class=p>:</span><span class=w>
</span><span class=w>      </span>- <span class=nt>port</span><span class=p>:</span><span class=w> </span><span class=m>6379</span><span class=w>
</span><span class=w>        </span><span class=nt>nodePort</span><span class=p>:</span><span class=w> </span><span class=m>30002</span><span class=w>
</span><span class=w>        </span><span class=nt>targetPort</span><span class=p>:</span><span class=w> </span><span class=m>6379</span><span class=w>
</span><span class=w>        </span><span class=nt>protocol</span><span class=p>:</span><span class=w> </span><span class=l>TCP</span><span class=w>
</span><span class=w>
</span></code></pre></div><p>這樣可以透過 localhost:30002 來連接到 k3d 內的 6379</p>
<ol start=2>
<li>透過 helm 安裝 etcd
<ul>
<li><a href=https://artifacthub.io/packages/helm/bitnami/etcd target=_blank rel="noopener noreffer">site</a></li>
</ul>
</li>
</ol>
<div class=highlight><pre tabindex=0 class=chroma><code class=language-shell data-lang=shell>helm install local-etcd bitnami/etcd
</code></pre></div><p>Result</p>
<div class=highlight><pre tabindex=0 class=chroma><code class=language-shell data-lang=shell>NAME: local-etcd
LAST DEPLOYED: Sun May  <span class=m>8</span> 22:35:19 <span class=m>2022</span>
NAMESPACE: default
STATUS: deployed
REVISION: <span class=m>1</span>
TEST SUITE: None
NOTES:
CHART NAME: etcd
CHART VERSION: 6.13.5
APP VERSION: 3.5.2

** Please be patient <span class=k>while</span> the chart is being deployed **

etcd can be accessed via port <span class=m>2379</span> on the following DNS name from within your cluster:

    local-etcd.default.svc.cluster.local

To create a pod that you can use as a etcd client run the following command:

    kubectl run local-etcd-client --restart<span class=o>=</span><span class=s1>&#39;Never&#39;</span> --image docker.io/bitnami/etcd:3.5.2-debian-10-r23 --env <span class=nv>ROOT_PASSWORD</span><span class=o>=</span><span class=k>$(</span>kubectl get secret --namespace default local-etcd -o <span class=nv>jsonpath</span><span class=o>=</span><span class=s2>&#34;{.data.etcd-root-password}&#34;</span> <span class=p>|</span> base64 --decode<span class=k>)</span> --env <span class=nv>ETCDCTL_ENDPOINTS</span><span class=o>=</span><span class=s2>&#34;local-etcd.default.svc.cluster.local:2379&#34;</span> --namespace default --command -- sleep infinity

Then, you can set/get a key using the commands below:

    kubectl <span class=nb>exec</span> --namespace default -it local-etcd-client -- bash
    etcdctl --user root:<span class=nv>$ROOT_PASSWORD</span> put /message Hello
    etcdctl --user root:<span class=nv>$ROOT_PASSWORD</span> get /message

To connect to your etcd server from outside the cluster execute the following commands:

    kubectl port-forward --namespace default svc/local-etcd 2379:2379 <span class=p>&amp;</span>
    <span class=nb>echo</span> <span class=s2>&#34;etcd URL: http://127.0.0.1:2379&#34;</span>

 * As rbac is enabled you should add the flag <span class=sb>`</span>--user root:<span class=nv>$ETCD_ROOT_PASSWORD</span><span class=sb>`</span> to the etcdctl commands. Use the <span class=nb>command</span> below to <span class=nb>export</span> the password:

    <span class=nb>export</span> <span class=nv>ETCD_ROOT_PASSWORD</span><span class=o>=</span><span class=k>$(</span>kubectl get secret --namespace default local-etcd -o <span class=nv>jsonpath</span><span class=o>=</span><span class=s2>&#34;{.data.etcd-root-password}&#34;</span> <span class=p>|</span> base64 --decode<span class=k>)</span>

</code></pre></div><p>建立一個 node port 來通 etcd</p>
<p>local-etcd-svc</p>
<div class=highlight><pre tabindex=0 class=chroma><code class=language-yaml data-lang=yaml><span class=nt>apiVersion</span><span class=p>:</span><span class=w> </span><span class=l>v1</span><span class=w>
</span><span class=w></span><span class=nt>kind</span><span class=p>:</span><span class=w> </span><span class=l>Service</span><span class=w>
</span><span class=w></span><span class=nt>metadata</span><span class=p>:</span><span class=w>
</span><span class=w>   </span><span class=nt>name</span><span class=p>:</span><span class=w> </span><span class=l>local-etcd-svc</span><span class=w>
</span><span class=w></span><span class=nt>spec</span><span class=p>:</span><span class=w>
</span><span class=w>   </span><span class=nt>type</span><span class=p>:</span><span class=w> </span><span class=l>NodePort</span><span class=w>
</span><span class=w>   </span><span class=nt>selector</span><span class=p>:</span><span class=w>
</span><span class=w>      </span><span class=nt>app.kubernetes.io/name</span><span class=p>:</span><span class=w> </span><span class=l>etcd</span><span class=w>
</span><span class=w>      </span><span class=nt>app.kubernetes.io/instance</span><span class=p>:</span><span class=w> </span><span class=l>local-etcd</span><span class=w>
</span><span class=w>      </span><span class=nt>app.kubernetes.io/managed-by</span><span class=p>:</span><span class=w> </span><span class=l>Helm</span><span class=w>
</span><span class=w>   </span><span class=nt>ports</span><span class=p>:</span><span class=w>
</span><span class=w>      </span>- <span class=nt>port</span><span class=p>:</span><span class=w> </span><span class=m>2379</span><span class=w>
</span><span class=w>        </span><span class=nt>nodePort</span><span class=p>:</span><span class=w> </span><span class=m>30003</span><span class=w>
</span><span class=w>        </span><span class=nt>targetPort</span><span class=p>:</span><span class=w> </span><span class=m>2379</span><span class=w>
</span><span class=w>        </span><span class=nt>protocol</span><span class=p>:</span><span class=w> </span><span class=l>TCP</span><span class=w>
</span><span class=w>
</span></code></pre></div><p>這樣可以透過 localhost:30002 來連接到 k3d 內的 2379</p>
</div>
<div class=post-footer id=post-footer>
<div class=post-info>
<div class=post-info-line>
<div class=post-info-mod>
<span>Updated on 2022-05-08</span>
</div>
<div class=post-info-license></div>
</div>
<div class=post-info-line>
<div class=post-info-md></div>
<div class=post-info-share>
<span></span>
</div>
</div>
</div>
<div class=post-info-more>
<section class=post-tags><i class="fas fa-tags fa-fw"></i>&nbsp;<a href=/tags/local/>local</a></section>
<section>
<span><a href=javascript:void(0); onclick=window.history.back()>Back</a></span>&nbsp;|&nbsp;<span><a href=/>Home</a></span>
</section>
</div>
<div class=post-nav><a href=/posts/golang/fundamental2/ class=prev rel=prev title=fundamental2><i class="fas fa-angle-left fa-fw"></i>fundamental2</a></div>
</div>
</article></div>
</main><footer class=footer>
<div class=footer-container><div class=footer-line>Powered by <a href=https://gohugo.io/ target=_blank rel="noopener noreffer" title="Hugo 0.89.2">Hugo</a> | Theme - <a href=https://github.com/HEIGE-PCloud/DoIt target=_blank rel="noopener noreffer" title="DoIt 0.2.13"><i class="far fa-edit fa-fw"></i> DoIt</a>
</div><div class=footer-line><i class="far fa-copyright fa-fw"></i><span itemprop=copyrightYear>2022</span><span class=author itemprop=copyrightHolder>&nbsp;<a href=/ target=_blank rel="noopener noreferrer"></a></span></div>
</div></footer></div>
<div id=fixed-buttons><a href=#back-to-top id=back-to-top-button class=fixed-button title="Back to Top">
<i class="fas fa-arrow-up fa-fw"></i>
</a><a href=# id=view-comments class=fixed-button title="View Comments">
<i class="fas fa-comment fa-fw"></i>
</a>
</div><div class=assets><script type=text/javascript src=/lib/lazysizes/lazysizes.min.js></script><script type=text/javascript src=/lib/topbar/topbar.min.js></script><script type=text/javascript src=/lib/pjax/pjax.min.js></script><script type=text/javascript src=/js/theme.min.js></script></div>
<div class=pjax-assets><script type=text/javascript src=/lib/clipboard/clipboard.min.js></script><script type=text/javascript>window.config={code:{copyTitle:"Copy to clipboard",maxShownLines:10},comment:{}}</script></div>
</body>
</html>